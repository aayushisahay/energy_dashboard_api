// run " npm install bootstrap " in terminal before changing the code to implement the form //
//run "npm install react-datepicker"//
// run "npm install react-router-dom"//

//EnergyChart.jsx

import React, { useEffect, useState } from 'react';
import Highcharts from 'highcharts';
import HighchartsReact from 'highcharts-react-official';
import { getEnergySummary, getSpaceWiseEnergy } from '../services/api';
import 'bootstrap/dist/css/bootstrap.min.css';

const EnergyChart = () => {
  const [lineChartOptions, setLineChartOptions] = useState(null);
  const [pieChartOptions, setPieChartOptions] = useState(null);

  const startTime = '2023-06-01T00:00:00';
  const endTime = '2025-05-31T23:00:00';
  const spaceIds = [1, 2, 3, 4, 6]; 

  useEffect(() => {
    const fetchData = async () => {
      try {
        const lineData = await getEnergySummary(spaceIds, startTime, endTime);

        const categories = lineData.hourlyAggregated.map(item => {
          const date = new Date(item.timestamp);
          return date.toLocaleString(undefined, {
            hour12: false,
            year: '2-digit',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        });

        const values = lineData.hourlyAggregated.map(item => item.energyConsumed);

        setLineChartOptions({
          chart: { height: 400, width: 1200 },
          title: { text: 'Energy Consumption Over Time' },
          xAxis: {
            categories,
            labels: {
              rotation: 45,
              style: { fontSize: '10px' }
            }
          },
          yAxis: { title: { text: 'Energy Consumed (kWh)' } },
          series: [{ name: 'Date', data: values }],
          tooltip: {
            formatter: function () {
              return `<b>${this.x}</b><br/>${this.series.name}: <b>${this.y.toFixed(2)} kWh</b>`;
            }
          }
        });

        const pieData = await getSpaceWiseEnergy(spaceIds, startTime, endTime);
        const pieSeries = pieData.totalBySpace
          .sort((a, b) => b.energyConsumed - a.energyConsumed)
          .slice(0, 5)
          .map(space => ({
            name: `Space ${space.spaceId}`,
            y: space.energyConsumed
          }));

        setPieChartOptions({
          chart: { type: 'pie', height: 300, width: 500 },
          title: { text: 'Top 5 Spaces by Energy Consumption' },
          series: [{
            name: 'Energy Consumed (kWh)',
            data: pieSeries
          }],
          tooltip: {
            pointFormat: '{series.name}: <b>{point.y:.2f} kWh</b>'
          },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %'
              }
            }
          }
        });

      } catch (error) {
        console.error("Error loading charts:", error);
      }
    };

    fetchData();
  }, []);

  return (
    <div className="container py-4">
      <div className="mb-5">
        {lineChartOptions ? (
          <HighchartsReact highcharts={Highcharts} options={lineChartOptions} />
        ) : (
          <p>Loading line chart...</p>
        )}
      </div>

      <div className="mb-5">
        {pieChartOptions ? (
          <HighchartsReact highcharts={Highcharts} options={pieChartOptions} />
        ) : (
          <p>Loading pie chart...</p>
        )}
      </div>
    </div>
  );
};

export default EnergyChart;


//api.js

import axios from 'axios';

const BASE_URL = 'http://localhost:5130/api';

export const getEnergySummary = async (spaceIds, startTime, endTime) => {
  try {
    const response = await axios.get(`${BASE_URL}/MeterReadings/energy-summary`, {
      params: { spaceIds, startTime, endTime }
    });
    return response.data;
  } catch (error) {
    console.error("API Error:", error);
    throw error;
  }
};

export const getSpaceWiseEnergy = async (spaceIds, startTime, endTime) => {
  try {
    const response = await axios.get(`${BASE_URL}/MeterReadings/space-wise-energy`, {
      params: { spaceIds, startTime, endTime }
    });
    return response.data;
  } catch (error) {
    console.error("API Error (space-wise-energy):", error);
    throw error;
  }
};

export const addSite = async (siteData) => {
  try {
    const response = await axios.post(`${BASE_URL}/Site/add-site`, siteData);
    return response.data;
  } catch (error) {
    console.error("API Error (add-site):", error);
    throw error;
  }
};

export const getSite = async () => {
  try {
    const response = await axios.get(`${BASE_URL}/Site/get-site`);
    return response.data;
  } catch (error) {
    console.error("API Error (get-site):", error);
    throw error;
  }
};

// GET /api/Sites/Single
export const getSingleSite = async () => {
  const response = await axios.get(`${BASE_URL}/Sites/Single`);
  return response.data;
};

// POST /api/Sites
export const addSite = async (siteData) => {
  const response = await axios.post(`${BASE_URL}/Sites`, siteData);
  return response.data;
};

// PUT /api/Sites/{id}
export const updateSite = async (id, siteData) => {
  const response = await axios.put(`${BASE_URL}/Sites/${id}`, siteData);
  return response.data;
};

//app.js 

import React from 'react';
import 'bootstrap/dist/css/bootstrap.min.css';
import './App.css';
import SideBar from './components/SideBar';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import Dashboard from './pages/Dashboard';
import Profile from './pages/Profile';
import Settings from './pages/Settings';
import Logout from './pages/Logout';

function App() {
  return (
    <Router>
      <div>
        <header className="app-header">
          <h1 className="app-title">Vatika Business Park</h1>
        </header>

        <div className="d-flex mt-5">
          <SideBar />
          <div className="flex-grow-1 p-4">
            <Routes>
              <Route path="/" element={<Dashboard />} />
              <Route path="/profile" element={<Profile />} />
              <Route path="/settings" element={<Settings />} />
              <Route path="/logout" element={<Logout />} />
            </Routes>
          </div>
        </div>
      </div>
    </Router>
  );
}

export default App;


//SideBar.jsx (folder->components)

import React from 'react';
import { Link } from 'react-router-dom';
import '../App.css'; 

const SideBar = () => {
  return (
    <div className="sidebar p-3">
      <h4 className="mb-4">Menu</h4>
      <hr></hr>
      <ul className="nav flex-column">
        <li className="nav-item">
          <Link to="/profile" className="nav-link">Profile</Link>
        </li>
        <li className="nav-item">
          <Link to="/" className="nav-link">Dashboard</Link>
        </li>
        <li className="nav-item">
          <Link to="/settings" className="nav-link">Settings</Link>
        </li>
        <li className="nav-item">
          <Link to="/logout" className="nav-link">Logout</Link>
        </li>
      </ul>
    </div>
  );
};

export default SideBar;


//Dashboard.jsx (folder->pages)

import React, { useEffect, useState } from 'react';
import Highcharts from 'highcharts';
import HighchartsReact from 'highcharts-react-official';
import { getEnergySummary, getSpaceWiseEnergy } from '../services/api';

const Dashboard = () => {
  const [lineChartOptions, setLineChartOptions] = useState(null);
  const [pieChartOptions, setPieChartOptions] = useState(null);

  const startTime = '2023-06-01T00:00:00';
  const endTime = '2025-05-31T23:00:00';
  const spaceIds = [1, 2, 3, 4, 6];

  useEffect(() => {
    const fetchData = async () => {
      try {
        const lineData = await getEnergySummary(spaceIds, startTime, endTime);

        const categories = lineData.hourlyAggregated.map(item => {
          const date = new Date(item.timestamp);
          return date.toLocaleString(undefined, {
            hour12: false, year: '2-digit', month: '2-digit',
            day: '2-digit', hour: '2-digit', minute: '2-digit'
          });
        });

        const values = lineData.hourlyAggregated.map(item => item.energyConsumed);

        setLineChartOptions({
          chart: { height: 400, width: 1200 },
          title: { text: 'Energy Consumption Over Time' },
          xAxis: {
            categories,
            labels: { rotation: 45, style: { fontSize: '10px' } }
          },
          yAxis: { title: { text: 'Energy Consumed (kWh)' } },
          series: [{ name: 'Date', data: values }],
          tooltip: {
            formatter: function () {
              return `<b>${this.x}</b><br/>${this.series.name}: <b>${this.y.toFixed(2)} kWh</b>`;
            }
          }
        });

        const pieData = await getSpaceWiseEnergy(spaceIds, startTime, endTime);
        const pieSeries = pieData.totalBySpace
          .sort((a, b) => b.energyConsumed - a.energyConsumed)
          .slice(0, 5)
          .map(space => ({
            name: `Space ${space.spaceId}`,
            y: space.energyConsumed
          }));

        setPieChartOptions({
          chart: { type: 'pie', height: 300, width: 500 },
          title: { text: 'Top 5 Spaces by Energy Consumption' },
          series: [{ name: 'Energy Consumed (kWh)', data: pieSeries }],
          tooltip: { pointFormat: '{series.name}: <b>{point.y:.2f} kWh</b>' },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %'
              }
            }
          }
        });

      } catch (error) {
        console.error("Error loading charts:", error);
      }
    };

    fetchData();
  }, []);

  return (
    <div>
      <h2>Dashboard</h2>
      <div className="mb-4">
        {lineChartOptions ? (
          <HighchartsReact highcharts={Highcharts} options={lineChartOptions} />
        ) : <p>Loading line chart...</p>}
      </div>
      <div>
        {pieChartOptions ? (
          <HighchartsReact highcharts={Highcharts} options={pieChartOptions} />
        ) : <p>Loading pie chart...</p>}
      </div>
    </div>
  );
};

export default Dashboard;

//Settings.jsx (folder->pages)

import React, { useState, useEffect } from 'react';
import 'bootstrap/dist/css/bootstrap.min.css';
import { getSite, addSite } from '../services/api';

const Settings = () => {
  const [formData, setFormData] = useState({
    siteName: '',
    location: '',
    contactPerson: '',
    contactEmail: '',
    contactPhone: '',
  });

  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    const fetchSite = async () => {
      try {
        const site = await getSite();
        setFormData(site);
      } catch (error) {
        console.error('Failed to fetch site data', error);
      }
    };
    fetchSite();
  }, []);

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleEdit = () => {
    setIsEditing(true);
  };

  const handleCancel = () => {
    setIsEditing(false);
    // Optionally reload original data
    // fetchSite(); // Uncomment this if you want to reload original values
  };

  const handleSave = async () => {
    try {
      await addSite(formData);
      alert('Site saved successfully!');
      setIsEditing(false);
    } catch (error) {
      alert('Error saving site');
    }
  };

  return (
    <div className="container mt-4">
      <div className="card p-4">
        <h4>Add New Site</h4>
        <form>
          <div className="mb-3">
            <label htmlFor="siteName" className="form-label">Site Name</label>
            <input
              type="text"
              className="form-control"
              id="siteName"
              name="siteName"
              value={formData.siteName}
              onChange={handleChange}
              disabled={!isEditing}
            />
          </div>
          <div className="mb-3">
            <label htmlFor="location" className="form-label">Address</label>
            <input
              type="text"
              className="form-control"
              id="location"
              name="location"
              value={formData.location}
              onChange={handleChange}
              disabled={!isEditing}
            />
          </div>
          <div className="mb-3">
            <label htmlFor="contactPerson" className="form-label">Contact Person</label>
            <input
              type="text"
              className="form-control"
              id="contactPerson"
              name="contactPerson"
              value={formData.contactPerson}
              onChange={handleChange}
              disabled={!isEditing}
            />
          </div>
          <div className="mb-3">
            <label htmlFor="contactEmail" className="form-label">Contact Email</label>
            <input
              type="email"
              className="form-control"
              id="contactEmail"
              name="contactEmail"
              value={formData.contactEmail}
              onChange={handleChange}
              disabled={!isEditing}
            />
          </div>
          <div className="mb-3">
            <label htmlFor="contactPhone" className="form-label">Contact Phone</label>
            <input
              type="tel"
              className="form-control"
              id="contactPhone"
              name="contactPhone"
              value={formData.contactPhone}
              onChange={handleChange}
              disabled={!isEditing}
            />
          </div>

          {!isEditing ? (
            <button type="button" className="btn btn-primary" onClick={handleEdit}>
              Edit
            </button>
          ) : (
            <div className="d-flex gap-2">
              <button type="button" className="btn btn-success" onClick={handleSave}>
                Save
              </button>
              <button type="button" className="btn btn-secondary" onClick={handleCancel}>
                Cancel
              </button>
            </div>
          )}
        </form>
      </div>
    </div>
  );
};

export default Settings;


//Profile.jsx (folder->pages)

import React from 'react';

const Profile = () => {
  return <h2>Profile Page</h2>;
};

export default Profile;


//Logout.jsx (folder->pages)

import React from 'react';

const Logout = () => {
  return <h2>You have been logged out.</h2>;
};

export default Logout;

//SiteForm.jsx (folder->components)

import React, { useEffect, useState } from 'react';
import { getSingleSite, addSite, updateSite } from '../services/api';

const SiteForm = () => {
  const [siteData, setSiteData] = useState({
    siteID: '',
    siteName: '',
    address: '',
    contactPerson: '',
    contactEmail: '',
    contactPhone: ''
  });

  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    const fetchSite = async () => {
      try {
        const data = await getSingleSite();
        setSiteData({
          siteID: data.siteID,
          siteName: data.siteName,
          address: data.address,
          contactPerson: data.contactPerson,
          contactEmail: data.contactEmail,
          contactPhone: data.contactPhone
        });
      } catch (error) {
        console.error("Error fetching site:", error);
      }
    };

    fetchSite();
  }, []);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setSiteData((prev) => ({
      ...prev,
      [name]: value
    }));
  };

  const handleEdit = () => {
    setIsEditing(true);
  };

  const handleCancel = () => {
    setIsEditing(false);
  };

  const handleSave = async () => {
    try {
      if (siteData.siteID) {
        await updateSite(siteData.siteID, siteData);
      } else {
        const newSite = await addSite(siteData);
        setSiteData((prev) => ({ ...prev, siteID: newSite.siteID }));
      }
      setIsEditing(false);
      alert('Site saved successfully');
    } catch (error) {
      console.error('Error saving site:', error);
      alert('Error saving site');
    }
  };

  return (
    <div className="card p-4">
      <h4 className="mb-4">Add New Site</h4>

      <div className="mb-3">
        <label className="form-label">Site ID</label>
        <input
          type="text"
          className="form-control"
          name="siteID"
          value={siteData.siteID}
          onChange={handleChange}
          disabled
        />
      </div>

      <div className="mb-3">
        <label className="form-label">Site Name</label>
        <input
          type="text"
          className="form-control"
          name="siteName"
          value={siteData.siteName}
          onChange={handleChange}
          disabled={!isEditing}
        />
      </div>

      <div className="mb-3">
        <label className="form-label">Address</label>
        <input
          type="text"
          className="form-control"
          name="address"
          value={siteData.address}
          onChange={handleChange}
          disabled={!isEditing}
        />
      </div>

      <div className="mb-3">
        <label className="form-label">Contact Person</label>
        <input
          type="text"
          className="form-control"
          name="contactPerson"
          value={siteData.contactPerson}
          onChange={handleChange}
          disabled={!isEditing}
        />
      </div>

      <div className="mb-3">
        <label className="form-label">Contact Email</label>
        <input
          type="email"
          className="form-control"
          name="contactEmail"
          value={siteData.contactEmail}
          onChange={handleChange}
          disabled={!isEditing}
        />
      </div>

      <div className="mb-3">
        <label className="form-label">Contact Phone</label>
        <input
          type="text"
          className="form-control"
          name="contactPhone"
          value={siteData.contactPhone}
          onChange={handleChange}
          disabled={!isEditing}
        />
      </div>

      {!isEditing ? (
        <button className="btn btn-primary" onClick={handleEdit}>Edit</button>
      ) : (
        <>
          <button className="btn btn-success me-2" onClick={handleSave}>Save</button>
          <button className="btn btn-secondary" onClick={handleCancel}>Cancel</button>
        </>
      )}
    </div>
  );
};

export default SiteForm;

//app.css

.App {
  text-align: center;
}

.App-logo {
  height: 40vmin;
  pointer-events: none;
}

@media (prefers-reduced-motion: no-preference) {
  .App-logo {
    animation: App-logo-spin infinite 20s linear;
  }
}

.App-header {
  background-color: #3a465d;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: calc(10px + 2vmin);
  color: white;
}

.App-link {
  color: #61dafb;
}

@keyframes App-logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.sidebar {
  background-color: #0d0e0e;
  color: rgb(255, 255, 255);
  width: 200px;
  height: 100vh;
}

.sidebar .nav-link {
  color: rgb(255, 255, 255);
  font-size: 16px;
  margin-bottom: 10px;
}

.sidebar .nav-link:hover {
  color: #61dafb; /* Light blue hover effect */
  text-decoration: none;
}


.app-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #f8f9fa;
  padding: 12px 24px;
  border-bottom: 1px solid #dee2e6;
  z-index: 1000;
}

.app-title {
  margin: 0;
  font-size: 28px;
  color:#000000;
  font-weight: bold;
}

.mt-5 {
  margin-top: 70px !important;
}
